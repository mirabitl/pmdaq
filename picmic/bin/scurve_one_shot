#!/usr/bin/env python3
import logging
import sys
import time
import matplotlib.pyplot as plt
import liroc_ptdc_daq as daq
import numpy as np 
import picmic_register_access as cra
import os
import json

#def main(state,version,feb_id,all_channels,loop_one,location=None,upload_comment=None,thmin=420,thmax=750,dc_pa=0,res_mode='coarse'):
def main(params):
    pb=picmic_scurve(params.feb,params.state,params.version,dc_pa=params.dcpa,res_mode=params.resmode)
    res={}
    res["state"]=params.state
    res["version"]=params.version
    res["feb"]=params.feb
    res["thmin"]=params.thmin
    res["thmax"]=params.thmax
    res["dcpa"]=params.dcpa
    res["thstep"]=1
    res["asic"]="LIROC"
    res["ctime"]=time.time()
    res["mode"]=params.resmode
    if (params.location!=None):
        res["location"]=params.location
   
    upload=(params.upload!=None)
    if (all_channels):
        res["analysis"]="SCURVE_A"
        res["channels"]=[]
        scurves=pb.scurve_all_channels(start=params.thmin,stop=params.thmax,step=1,dac_loc=0)
        for liroc_chan in daq.FebBoard.MAP_LIROC_TO_PTDC_CHAN.keys():
            rc={}
            rc["prc"]=liroc_chan
            rc["tdc"]=daq.FebBoard.MAP_LIROC_TO_PTDC_CHAN[liroc_chan]
            rc["scurve"]=scurves[daq.FebBoard.MAP_LIROC_TO_PTDC_CHAN[liroc_chan]]
            res["channels"].append(rc)
            plt.plot(range(params.thmin, params.thmax,1), scurves[liroc_chan], '+-', label=f"ch{liroc_chan}")
        plt.grid()
        plt.legend(loc="upper right")
        plt.show()
        runid=None
        if params.upload!=None and params.location!=None :
            runobj=pb.sdb.getRun(params.location,params.upload)
            runid=runobj['run']

        # Store results in json
        res_dir='results/%s_%d_f_%d' % (params.state,params.version,params.feb)
        if runid==None:
            runid=int(input("Enter a run number: "))
        os.system("mkdir -p %s" % res_dir)
        fout=open(f"{res_dir}/scurves_all_channels_{runid}.json","w")
        fout.write(json.dumps(res))
        fout.close

        if params.upload!=None and params.location!=None :
            pb.sdb.upload_results(runid,params.location,res["state"],res["version"],res["feb"],res["analysis"],res,params.upload)

    elif loop_one:
        res["analysis"]="SCURVE_1"
        res["channels"]=[]
        scurves=pb.scurve_loop_one(start=params.thmin,stop=params.thmax,step=1,dac_loc=0)
        for liroc_chan in daq.FebBoard.MAP_LIROC_TO_PTDC_CHAN.keys():
            rc={}
            rc["prc"]=liroc_chan
            rc["tdc"]=daq.FebBoard.MAP_LIROC_TO_PTDC_CHAN[liroc_chan]
            rc["scurve"]=scurves[liroc_chan]
            res["channels"].append(rc)
            plt.plot(range(params.thmin, params.thmax,1), scurves[liroc_chan], '+-', label=f"ch{liroc_chan}")
        plt.grid()
        plt.legend(loc="upper right")
        plt.show()
        runid=None
        if params.upload!=None and params.location!=None:
            runobj=pb.sdb.getRun(params.location,params.upload)
            runid=runobj['run']
        # Store results in json
        res_dir='results/%s_%d_f_%d' % (params.state,params.version,params.feb)
        if runid==None:
            runid=int(input("Enter a run number: "))
        os.system("mkdir -p %s" % res_dir)
        fout=open(f"{res_dir}/scurves_1_channels_{runid}.json","w")
        fout.write(json.dumps(res))
        fout.close

        if params.upload!=None and params.location!=None:
            pb.sdb.upload_results(runid,params.location,res["state"],res["version"],res["feb"],res["analysis"],res,params.upload)
            
    else:
        target,v_dac_local=pb.calib_iterative_dac_local(params.thmin,params.thmax)
        print(target)
        print(v_dac_local)
        # Upload to DB
        for  ich in range(len(v_dac_local)):
            pb.sdb.setup.boards[0].picmic.set("DAC_local_ch",v_dac_local[ich],ich)
            print(f"DAC_local_ch{ich}",v_dac_local[ich])
        tlsb=target&0xFF
        tmsb=(target>>8)&0xFF
        pb.sdb.setup.boards[0].picmic.set("dac_threshold_lsb",tlsb)
        pb.sdb.setup.boards[0].picmic.set("dac_threshold_msb",tmsb)
        #results=make_pedestal_all_channels(state,version,feb_id,feb,an,thi,tha,1,v6=v6_cor)
        #val=input("Next ASIC ? ")
            
    
        if (params.upload!=None):
            cm=params.upload
            pb.sdb.setup.version=params.version
            pb.sdb.upload_changes(cm)
        else:
            pb.sdb.setup.version=999
            pb.sdb.setup.to_csv_files()
                
                

    

    
if __name__ == '__main__':
    import argparse
    parser = argparse.ArgumentParser()
    
    # configure all the actions
    grp_action = parser.add_mutually_exclusive_group()
    grp_action.add_argument('--allchan', dest='allchan', default=False, action='store_true',help="Make Scurve allchannels on")
    grp_action.add_argument('--one', dest='one', default=False, action='store_true',help="Make Scurve one by one")
    # Arguments
    parser.add_argument('--state', action='store', type=str,default=None, dest='state', help='DB State')
    parser.add_argument('--version', action='store',type=int,default=None,dest='version',help='DB state version' )
    parser.add_argument('--feb', action='store', type=int,default=None, dest='feb', help='FEB id')
    parser.add_argument('--min', action='store', type=int,default=400, dest='thmin', help='Minimal 10b dac')
    parser.add_argument('--max', action='store', type=int,default=700, dest='thmax', help='Maximal 10b dac')

    parser.add_argument('--dcpa', action='store', type=int,default=0, dest='dcpa', help='DC_PA common value')

    parser.add_argument('--upload', action='store', type=str,default=None, dest='upload', help='Upload comment')
    parser.add_argument('--location', action='store', type=str,default=None, dest='location', help='Experiment name')
    
    parser.add_argument('--resolution', action='store', type=str,default='coarse', dest='resmode', help='Resolution mode')

    results = parser.parse_args()
    print(results)

    if (results.state==None):
        print("--state should be specified")
        exit(0)
    if (results.version==None):
        print("--version should be specified")
        exit(0)
    if (results.feb==None):
        print("--feb should be specified")
        exit(0)

        
    state=results.state
    version=results.version
    feb_id=results.feb
    all_channels=results.allchan
    loop_one=results.one
    thi=results.thmin
    tha=results.thmax
    cm_up=None
    if (results.upload!=None):
        cm_up=results.upload
    #main(state,version,feb_id,all_channels,loop_one,location=results.location,upload_comment=cm_up,thmin=thi,thmax=tha,dc_pa=results.dcpa,res_mode=results.resmode)
    main(results)
